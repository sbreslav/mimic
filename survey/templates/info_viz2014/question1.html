{% load staticfiles %}
<script type="text/javascript">
     function showPage(elementID) {
                // try to find the requested page and alert if it's not found
                $(".page").hide();
                $(elementID).show();
              
    }

    function createLikertScale(name, width, labels, onchange) {
            var nbValues = labels.length;
            var s = "";
            s += '<table id="LikertScale_'+name+'" width="' + width + '" border="0" cellspacing="3" style="table-layout:fixed; border-width: 1px; border-color:#CCCCCC; border-style: solid;">';
            for (var i=1; i<=nbValues; i++)
                    s += '<col id="col_'+i+'" width="' + width/nbValues + '" align="center">';
            
            s += '<tr id="LikertScale_tr_1" style="font-size: 95%">';
            for (var i=1; i<=nbValues; i++)
                    s += '<td id="td_' + (name + i + "label") + '" align="center"><span id="' + (name + i + "label") + '">' + labels[i-1] + '</span></td>';
            
            s += '</tr><tr id="LikertScale_tr_1">';

            for (var i=1; i<=nbValues; i++)
                    s += '<td id="td_'+ (name + i) +'" align="center"><label id="label_'+ (name + i) +'" class="radio-inline"><input type="radio" id="' + (name + i) + '" name="' + name + '" value="' + i + '" onclick="' + onchange + '">' + i + '</label></td>';
            s += '</tr></table>';
            document.write(s);
    }

    function getHTMLforScenarioText(text)
    {
       var s = "";
       //s+= '<hr id="hr_scenario">';
       textHTML = text;
       s+= '<table id="scenarioTable" border="0" cellpadding="0" cellspacing="10" width="100%"><tr id="scenarioTable_tr1" valign="top"> \
            <td id="scenarioTable_td2"><div id="scenarioTable_div1" style="background: #F5F5F5; padding: 1em; border: #D0D0D0 solid 1px;">' + textHTML + '</div></td></tr></table>';
       return s;
    }

    function getHTMLforQuestion( question)
    {
       var s = "";
       s += '<br id="br1"><strong id="description_paragraph6">Please answer the following question:</strong>';
       //s += '<br id="br1"><strong id="description_paragraph6">Please answer the following question given information below:</strong>'; 
       s += '<p id="question1"><div id="question1_div" style="background: #F5F5F5; padding: 1em; border: #D0D0D0 solid 1px;">' + question + '</div></p>';
       //s += '</table>';
       return s;
    }

    function getHTMLforDiagram(c1_image_path, condition)
    {
        var s = "";
        if (condition > 0) {
                    s += '<br id="brdiagram"><strong id="description_paragraph4">This is illustrated by the following diagram:</strong>';
                    //s += '<br id="brdiagram"><strong id="description_paragraph4">Given infromation is further illustrated by the following diagram:</strong>';
                    s += '<p id="description_paragraph5"><img id="diagram1" style="width: 50%;"alt="" src ="'+ c1_image_path + condition+'.png"/></p>';
        }else{
             s += '<br id="brdiagram"><strong id="description_paragraph4">This is further illustrated by the following data:</strong>';
                    //s += '<br id="brdiagram"><strong id="description_paragraph4">Given infromation is further illustrated by the following diagram:</strong>';
             s += '<p id="description_paragraph5"><img id="diagram1" style="width: 50%;"alt="" src ="'+ c1_image_path + condition+'.png"/></p>';
        }
        return s;
    }

    function checkResolution(width,height){
        if(screen.width < width || screen.height < height){
            window.location.replace("./survey/not_supported/");
        }

    }

    $(document).ready(function() {
        var questionData = {{ question|safe}};
        var questionCondition = {{ condition|safe}};
        var total_pages =  2;
        var current_question =  parseInt({{qnum|safe}});
        var answer = "";
        var confidence = 0;
        var worker_id = {{worker_id|safe}};
        var condition = {{condition|safe}};
        
        var scenario_text = "10 out of every 1,000 women at age forty who participate in routine screening have breast cancer. <br id='br2'>8 of every 10 women with breast cancer will get a positive mammography. <br id='br3'>95 out of every 990 women without breast cancer will also get a positive mammography. <br id='br5'>";
        var question = "There is a new representative sample of women at age forty who got a positive mammography in routine screening. <br id='br4'>How many of these women do you expect to actually have breast cancer?";
        var c1_image_path = "{% static 'img/infoViz2014_exp1/diagram_' %}";

        $('#scenario').html(getHTMLforScenarioText(scenario_text));
        $('#scenario_question').html(getHTMLforQuestion(question));
        $('#scenario_diagram').html(getHTMLforDiagram(c1_image_path, condition));

        checkResolution(1024,768);
        
        // First submit to start
        $('#submitButton1').click(function() {
            current_question++;
            showPage("#page"+current_question.toString());
            $('#submitButton1').prop('disabled', true);
        });
        
        // Question submits
        $('.submit').click(function() {
            $(".error").html("");
            if(current_question == 0){
                var a1 = $('input:text[name=answer1]').val();
                var a2 = $('input:text[name=answer2]').val();
                confidence = $('input:radio[name=confidence]:checked').val();
                //console.log(b);
                if(!a1 || !a2){
                
                    $(".error").html("<div id='myerror4' class='alert alert-error'>Error: Please fill out all the fields to proceed.</div>");
                    return;     
                }
                if(!confidence){
                     $(".error").html("<div id='myerror3' class='alert alert-error'>Error: Please indicate your level of confidence to proceed.</div>");
                     return;
                }
                if(!a1.match(/^\d+$/) || !a2.match(/^\d+$/)) {
                   $(".error").html("<div id='myerror2' class='alert alert-error'>Error: Answer must be a number.</div>");
                   return;     
                }
                answer = {'a1':a1, 'a2':a2};
                
            }
            $('.submit').prop('disabled', true);
            var concatLogBuffer = JSON.stringify(logBuffer);
            $.post("./survey/save_question/", { 'mouseData': concatLogBuffer, 
                                                'currentQ': current_question,
                                                'answer': JSON.stringify(answer),
                                                'confidence':confidence,
                                                'worker_id':worker_id,
                                                'condition':condition,
                                                'csrfmiddlewaretoken': '{{ csrf_token }}'} ).done(function() {
                logBuffer = [];

                current_question++;
           
                $("#currentQ").val(current_question);        

                if(total_pages == current_question){
                    $('#mainForm').submit();
                    $(window).unbind('beforeunload');
                }
            
                showPage("#page"+current_question.toString());
                $('.submit').prop('disabled', false);
            }).fail(function() {
                $('.submit').prop('disabled', false);
                $(".error").html("<div id='myerror1' class='alert alert-error'>Error: didn't work, please try again.</div>");
            });

           
            
        });

        $(".answer").keydown(function(event) {
            var key = event.charCode || event.keyCode || 0;
            // Allow: backspace, delete, tab, escape, and enter
            if ( key == 46 ||key == 8 ||key == 9 || key == 27 || key == 13 || 
                 // Allow: Ctrl+A
                (key == 65 && key === true) || 
                 // Allow: home, end, left, right
                (key >= 35 && key <= 39)) {
                     // let it happen, don't do anything
                     return;
            }
            else {
                // Ensure that it is a number and stop the keypress
                if (event.shiftKey || (key < 48 || key > 57) && (key < 96 || key > 105 )) {
                    event.preventDefault(); 
                }   
            }
        });

        $(window).on('beforeunload', function(){
          // Save the questions
          var concatLogBuffer = JSON.stringify(logBuffer);
          $.post("./survey/save_question/", { 'mouseData': concatLogBuffer, 'csrfmiddlewaretoken': '{{ csrf_token }}'} );
          return ''; //Are you sure you want to leave?';
        });
        $('.enter_full_screen').click(function () {
            if (screenfull.enabled) {
                screenfull.request();
            }
        });
    
        var fullscreen = true; //screenfull.isFullscreen || (window.innerWidth == screen.width && window.innerHeight == screen.height);
        if(fullscreen){
               
                $('.submit').prop('disabled', false);
                $('.submit_button_div').show("slow");
                $('#myModal').modal('hide');
                
            }else{
                $('.submit').prop('disabled', true);
                $('.submit_button_div').hide();
                if(current_question > 0){
                    $('#myModal').modal('show');
                }
            }
        

        $(window).resize(function( e ) {
            var fullscreen = true; //screenfull.isFullscreen || (window.innerWidth == screen.width && window.innerHeight == screen.height);
            if(fullscreen){
                $('.submit').prop('disabled', false);
                $('.submit_button_div').show("slow");
                $('#myModal').modal('hide');
                
            }else{
                $('.submit').prop('disabled', true);
                $('.submit_button_div').hide();
                if(current_question > 0){
                    $('#myModal').modal('show');
                }
                
            }

        });
        
        showPage("#page0");

    });

</script>

<!-- PAGE 1 - GENERAL INSTRUCTIONS -->
<div id="page0" class="page">
<p id="page_count">Page 1/4</p><hr id="hr1">

<center class="scaled_text" id="center1"><h3 id="page_title">Scientific Study on Judgment and Visualization</h3></center>

<h5 class="scaled_text" id="description_title1">Important:</h5>


<p class="scaled_text" id="description_paragraph1">You can participate in this series of experiments <b id="bold1">only once</b>. If you have already completed a HIT with the same title (even a while ago), you <b id="bold2">cannot</b> complete this one and we would have to reject your HIT.</p>
<p class="scaled_text" id="description_paragraph2">This HIT takes about 5 minutes to complete.</p>
<p class="scaled_text" id="description_paragraph3">Read the instructions carefully and answer all questions before proceeding to the next page. HITs that are not completed carefully will be <b id="bold3">rejected</b> and the worker will not be paid.</p>
<p class="scaled_text" id="description_paragraph4">You should remain focused, and once you start the HIT, you must not stop unless you have completed all the pages. Special attention must be given to the next page.</p>
<p class="scaled_text" id="question1">To maximize your concentration on this HIT, we ask you to take it in <b id="bold4">Full Screen Mode.</b></p>
<p class="scaled_text" id="description_paragraph1"> </p>    
<p class="scaled_text" id="question1">To enter <b id="bold6">Full Screen Mode</b>, please press <b id="bold8">F11</b> on your keyboard or click this button: <button id="enter_full_screen1" type="button" class="btn btn-default enter_full_screen">Enter Full Screen Mode</button></p> (Your browser may ask you to "Allow" access for this)
<div id="submit_button_div1" class="submit_button_div">
<hr id="hr2">
<p class="scaled_text" id="question1"><b id="bold7">Full Screen Mode</b> entered successfully, please proceed to take the survey.</p>
<input class="btn btn-default" id="submitButton1" type="submit" name="submit" value="Next page">
<font id="font1" color="#999999"><div id="firstbuttonmessage">(you cannot return to this page afterwards)</div></font>
<div id="error" class="error text-danger"></div>
</div>
</div>

<!-- PAGE 2 - QUESTION -->
<div id="page1" class="page">

  <div id="im_description_row" class="row">
    <div id="im_description_col" class="scaled_text width100 col-xs-10 col-sm-10 col-md-10">
        <p id="page_count">Page 2/4</p>
        <strong id="description_paragraph1">Read the text below carefully and answer the question as best as you can.</strong>
        <!--<p id="description_paragraph1">Study the diagram below carefully and answer the question as best as you can.</p>-->
        <div id='scenario'></div>    
        <div id='scenario_diagram'></div>  
        <div id='scenario_question'></div> 
        <div id='scenario_answer'>
            <strong id="answer_label_strong">Answer:</strong>
            <div id="a_row" class="row scaled_text">
                <div id="a_col" class="scaled_text col-xs-10 col-sm-10 col-md-10">
                <input id="intput_a1" class="answer" name="answer1" type="text" placeholder="">&nbsp;<strong id="stron_a">of</strong>&nbsp;
                <input id="intput_a2" class="answer" name="answer2" type="text" placeholder=""> <strong id="stron_a">Women</strong>
                </div>
            </div>
        </div>   
          
    </div>
 </div>
    <br id="br3dd15"> 
<div id="conf_row" class="row">
    <div id="conf_col" class="scaled_text col-xs-10 col-sm-10 col-md-10">
    <p id="conf_p">How confident are you in your answer?</p>
    </div>
</div>
   
    <script type="text/javascript">
        createLikertScale('confidence', 400, ['No Confidence', '', 'Reasonable Confidence', '', 'Very High Confidence']); 
    </script>

    
    <br id="br314"><br id="br315">
    <div id="submit_button_div2" class="submit_button_div">
    <button id="submitButton2" type="submit" class="btn btn-default submit">Submit</button>
    <div id="error" class="error text-danger"></div>
    </div>
</div>

<!-- FORM - QUESTION -->
<form id="mainForm" action="/?worker_id={{worker_id}}&condition={{condition}}" method="post">{% csrf_token %}
    <input type="hidden" id="currentQ" name="currentQ" value="{{qnum}}">
    <input type="hidden" name="worker_id" value="{{worker_id}}">
    <input type="hidden" name="condition" value="{{condition}}">
</form>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="myModalLabel" aria-hidden="true">
  <div id="modal-dialog" class="modal-dialog">
    <div id="modal-content" class="modal-content">
      <div id="modal-header" class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Full Screen Mode</h4>
      </div>
      <div id="modal-body" class="modal-body">
        Please stay in Full Screen Mode.
      </div>
      <div id="modal-footer" class="modal-footer">
        <button id="enter_full_screen2" type="button" class="btn btn-primary enter_full_screen">Enter Full Screen Mode</button></p>
      </div>
    </div>
  </div>
</div>